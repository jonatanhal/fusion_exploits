#include<stdio.h>
#include<string.h>
#include<stdlib.h>
#include<unistd.h>

unsigned int
hash(const unsigned char *str, int length, unsigned int mask)
{
  unsigned int h = 0xfee13117;
  int i;

  for(h = 0xfee13117, i = 0; i < length; i++) {
    h ^= str[i];
    h += (h << 11);
    h ^= (h >> 7);
    h -= str[i];

    /*if (i == length-1) {
      printf("[hash,%d] last: %x\n",length,h);
      }*/
  }
  h += (h << 3);
  h ^= (h >> 10);
  h += (h << 15);
  h -= (h >> 17);

  //printf("[hash,%d] before mask: %x\n",length,h);
  
  return (h & mask);
}

void gen_random(char *s, const int len) {
    static const char alphanum[] =
        "0123456789"
        "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
        "abcdefghijklmnopqrstuvwxyz";

    for (int i = 0; i < len; ++i) {
        s[i] = alphanum[rand() % (sizeof(alphanum) - 1)];
    }

    s[len] = 0;
}

const size_t length = 128;

int vacancy(unsigned int index[]) {
  int vacant = 0;
  for (size_t i = 0; i < length; i++) {
    if (!index[i]) {
      vacant = 1;
    }
  }
  return vacant;
}

void mutate(unsigned char *prefix) {
  void *p = malloc(32);
}

int main(int argc, char **argv) {
  /*unsigned char buf[32];
  read(0, buf, sizeof(buf));
  int index = hash(buf,32,mask);
  printf("%d\n",index);*/
  unsigned int index[length];
  while ((opt = getopt(argc, argc, "gp:")) != -1) {
    switch (opt) {
    case 'g':
      // generate vanilla indexes
      while (vacancy(index)) {
	unsigned char candidate[22];
	gen_random(candidate,22);
	unsigned int i = hash(candidate,22,lenth-1);
	if (!index[i]) {
	  printf("%d %s\n",i,candidate);
	  index[i] = 1;
	}
      }
      break;
    case 'p':
      void *p = malloc(32);
      unsigned char *prefix = snprintf((char *)p, 32, "%s", optarg);
      mutate(prefix);
      free(p);
    default:
      fprintf(stderr,"Usage: %s (-g|-p PREFIX)\n", argv[0]);
      exit(-1);
    }
  }
}
